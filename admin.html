<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±ªå¤§å¤§ - ç¸½éƒ¨ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', sans-serif; }
        .nav-tabs .nav-link.active { background-color: #fff; border-bottom-color: #fff; font-weight: bold; color: #0d6efd; }
        .nav-tabs .nav-link { color: #6c757d; cursor: pointer; }
        .table-card { background: white; border-radius: 0 0 10px 10px; border: 1px solid #dee2e6; border-top: none; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark">ğŸ— è±ªå¤§å¤§ç¸½éƒ¨ç³»çµ±</h2>
        <span class="badge bg-secondary">Admin Panel v3.0</span>
    </div>

    <ul class="nav nav-tabs">
        <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'orders' }" @click="switchTab('orders')">ğŸ“‹ è¨‚å–®ç´€éŒ„</a></li>
        <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'users' }" @click="switchTab('users')">ğŸ‘¥ åˆ†åº—å¸³è™Ÿ</a></li>
        <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'inventory' }" @click="switchTab('inventory')">ğŸ“¦ å€‰å„²ç®¡ç†</a></li>
        <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'products' }" @click="switchTab('products')">âš™ï¸ å•†å“é…ç½®</a></li>
    </ul>

    <div class="table-card p-4 shadow-sm bg-white" v-cloak>
        
        <div v-if="currentTab === 'orders'">
            
            <div class="card bg-light border-0 p-3 mb-3">
                <div class="row g-2 align-items-center">
                    <div class="col-md-auto fw-bold text-muted">ğŸ” ç¯©é¸æ¢ä»¶:</div>
                    
                    <div class="col-md-3">
                        <select class="form-select" v-model="filters.store">
                            <option value="">å…¨éƒ¨è±ªå¤§å¤§åˆ†åº—</option>
                            <option v-for="u in users" :key="u.id" :value="u.display_name">
                                {{ u.display_name }}
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white">ğŸ“…</span>
                            <input type="text" id="orderDatePicker" class="form-control bg-white" placeholder="å…¨éƒ¨æ—¥æœŸ" readonly>
                        </div>
                    </div>

                    <div class="col-md-auto ms-auto d-flex gap-2">
                        <button class="btn btn-primary" @click="fetchOrders">ğŸ” æœå°‹</button>
                        <button class="btn btn-outline-secondary" @click="resetFilters">é‡ç½®</button>
                        <div class="vr mx-1"></div> <button class="btn btn-success" @click="exportToExcel">ğŸ“¥ åŒ¯å‡º Excel</button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light"><tr><th>æ™‚é–“</th><th>ç·¨è™Ÿ</th><th>åˆ†åº—</th><th>å•†å“</th><th>æ•¸é‡</th><th>ç‹€æ…‹</th></tr></thead>
                    <tbody>
                        <tr v-for="order in orders" :key="order.order_no">
                            <td class="small text-muted">{{ order.time }}</td><td class="fw-bold text-primary small">{{ order.order_no }}</td>
                            <td>{{ order.store }}</td><td>{{ order.product }}</td><td class="fw-bold">{{ order.qty }}</td>
                            <td><span class="badge bg-success">å·²ç¢ºèª</span></td>
                        </tr>
                        <tr v-if="orders.length === 0"><td colspan="6" class="text-center text-muted py-5">
                            ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¨‚å–®<br><small>è©¦è©¦åˆ‡æ›ç¯©é¸æ¢ä»¶</small>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentTab === 'users'">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <p class="text-muted mb-0 small">ç®¡ç†åˆ†åº—æ¬Šé™ã€‚</p>
                <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#userModal">â• æ–°å¢å¸³è™Ÿ</button>
            </div>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light"><tr><th>ID</th><th>å¸³è™Ÿ</th><th>åˆ†åº—åç¨±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th><th>å¯†ç¢¼</th></tr></thead>
                    <tbody>
                        <tr v-for="user in users" :key="user.id" :class="{'table-secondary': !user.is_active}">
                            <td>{{ user.id }}</td><td class="fw-bold">{{ user.username }}</td><td>{{ user.display_name }}</td>
                            <td><span v-if="!user.is_active" class="badge bg-secondary">åœç”¨</span><span v-else-if="user.is_reset_needed" class="badge bg-warning text-dark">å¾…æ”¹å¯†ç¢¼</span><span v-else class="badge bg-success">æ­£å¸¸</span></td>
                            <td><button class="btn btn-sm" :class="user.is_active ? 'btn-outline-danger' : 'btn-outline-success'" @click="toggleUser(user)">{{ user.is_active ? 'â›” åœç”¨' : 'âœ… å•Ÿç”¨' }}</button></td>
                            <td><button class="btn btn-sm btn-outline-dark" @click="resetPassword(user)">ğŸ”„ é‡ç½®</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentTab === 'inventory'">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <p class="text-muted mb-0 small">ç®¡ç†ç¸½å€‰åº«å­˜ã€‚</p>
                <button class="btn btn-primary btn-sm" @click="fetchInventory">ğŸ”„ åˆ·æ–°</button>
            </div>
            <table class="table align-middle table-bordered mb-5">
                <thead class="table-light"><tr><th>SKU</th><th>å•†å“</th><th class="text-end">ç›®å‰åº«å­˜</th><th>å–®ä½</th><th class="text-center">æ“ä½œ</th></tr></thead>
                <tbody>
                    <tr v-for="item in inventory" :key="item.id">
                        <td class="text-muted small font-monospace">{{ item.sku }}</td>
                        <td class="fw-bold">{{ item.name }}</td>
                        <td class="text-end fw-bold fs-5" :class="item.current_stock < 100 ? 'text-danger' : 'text-dark'">{{ item.current_stock }}</td>
                        <td class="text-muted">{{ item.base_unit }}</td>
                        <td class="text-center"><button class="btn btn-sm btn-outline-primary" @click="openRestockModal(item)">ğŸ“ èª¿æ•´</button></td>
                    </tr>
                </tbody>
            </table>
            <hr class="my-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold text-dark">ğŸ“… é€²å‡ºè²¨æ­·å²ç´€éŒ„</h4>
                <div class="d-flex align-items-center">
                    <label class="me-2 text-muted fw-bold">é¸æ“‡æœˆä»½:</label>
                    <div class="input-group" style="width: 250px;">
                        <span class="input-group-text bg-white">ğŸ“…</span>
                        <input type="text" id="monthPicker" class="form-control bg-white" placeholder="è«‹é»æ“Šé¸æ“‡æ—¥æœŸ..." readonly>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-dark"><tr><th>æ™‚é–“</th><th>å•†å“</th><th>è®Šå‹•</th><th>å‚™è¨»</th></tr></thead>
                    <tbody>
                        <tr v-for="log in inventoryLogs" :key="log.time">
                            <td class="small">{{ log.time }}</td><td>{{ log.product }}</td>
                            <td class="fw-bold" :class="log.qty > 0 ? 'text-success' : 'text-danger'">{{ log.qty > 0 ? '+' : '' }}{{ log.qty }} {{ log.unit }}</td>
                            <td class="text-muted small">{{ log.note }}</td>
                        </tr>
                        <tr v-if="inventoryLogs.length === 0"><td colspan="4" class="text-center py-3 text-muted">æœ¬æœˆç„¡ç´€éŒ„</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentTab === 'products'">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="alert alert-info py-2 mb-0 small">
                    <i class="bi bi-info-circle"></i> æ­¤è™•è¨­å®šåº—é•·å¯è¦‹çš„å•†å“åŠä¸‹å–®å–®ä½ã€‚
                </div>
                <button class="btn btn-primary btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#newProductModal">â• æ–°å¢å•†å“</button>
            </div>

            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr><th>ID</th><th>SKU</th><th>å•†å“åç¨±</th><th>åº«å­˜å–®ä½ (Base)</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in inventory" :key="item.id" :class="{'table-secondary': !item.is_active}">
                            <td>{{ item.id }}</td>
                            <td class="font-monospace text-muted">{{ item.sku }}</td>
                            <td class="fw-bold">{{ item.name }}</td>
                            <td>{{ item.base_unit }}</td>
                            <td>
                                <span v-if="item.is_active !== false" class="badge bg-success">ä¸Šæ¶ä¸­</span> <span v-else class="badge bg-secondary">å·²ä¸‹æ¶</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark me-2" @click="openUnitModal(item)">âš™ï¸ è¨­å®šå–®ä½</button>
                                <button class="btn btn-sm" :class="item.is_active !== false ? 'btn-outline-danger' : 'btn-outline-success'" @click="toggleProduct(item)">
                                    {{ item.is_active !== false ? 'ğŸ”½ ä¸‹æ¶' : 'ğŸ”¼ ä¸Šæ¶' }}
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr class="my-5">
            
            <h4 class="fw-bold text-dark mb-3">ğŸ› ï¸ é…ç½®è®Šæ›´ç´€éŒ„ (æœ€è¿‘ 50 ç­†)</h4>
            
            <div class="table-responsive">
                <table class="table table-striped align-middle border">
                    <thead class="table-secondary">
                        <tr>
                            <th style="width: 180px;">æ“ä½œæ™‚é–“</th>
                            <th style="width: 150px;">ç›¸é—œç”¢å“</th>
                            <th style="width: 120px;">å‹•ä½œ</th>
                            <th>è©³ç´°å…§å®¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="log in productLogs" :key="log.time">
                            <td class="small text-muted">{{ log.time }}</td>
                            <td class="fw-bold">{{ log.product }}</td>
                            <td>
                                <span class="badge" 
                                    :class="{
                                        'bg-primary': log.action === 'æ–°å¢ç”¢å“',
                                        'bg-warning text-dark': log.action === 'ç‹€æ…‹è®Šæ›´',
                                        'bg-info text-dark': log.action === 'æ–°å¢å–®ä½',
                                        'bg-danger': log.action === 'åˆªé™¤å–®ä½'
                                    }">
                                    {{ log.action }}
                                </span>
                            </td>
                            <td class="small">{{ log.details }}</td>
                        </tr>
                        <tr v-if="productLogs.length === 0">
                            <td colspan="4" class="text-center py-3 text-muted">æš«ç„¡é…ç½®è®Šæ›´ç´€éŒ„</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">æ–°å¢å¸³è™Ÿ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="createUser"><div class="mb-3"><label>å¸³è™Ÿ</label><input type="text" class="form-control" v-model="newUser.username" required></div><div class="mb-3"><label>åˆ†åº—å</label><input type="text" class="form-control" v-model="newUser.display_name" required></div><div class="mb-3"><label>å¯†ç¢¼</label><input type="text" class="form-control" v-model="newUser.password" required></div><button type="submit" class="btn btn-dark w-100">å»ºç«‹</button></form></div></div></div></div>
    
    <div class="modal fade" id="restockModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">åº«å­˜èª¿æ•´</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" v-if="selectedProduct"><h5 class="fw-bold">{{ selectedProduct.name }}</h5><p>ç›®å‰: {{ selectedProduct.current_stock }} {{ selectedProduct.base_unit }}</p><form @submit.prevent="submitRestock"><div class="mb-3"><label>æ•¸é‡ ({{ selectedProduct.base_unit }})</label><input type="number" step="0.01" class="form-control" v-model.number="restockForm.quantity" placeholder="æ­£æ•¸å…¥è²¨ï¼Œè² æ•¸æ‰£æ¸›" required></div><div class="mb-3"><label>å‚™è¨»</label><input type="text" class="form-control" v-model="restockForm.note"></div><button type="submit" class="btn btn-primary w-100">ç¢ºèª</button></form></div></div></div></div>

    <div class="modal fade" id="newProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">æ–°å¢å•†å“</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="createProduct"><div class="mb-3"><label>å•†å“åç¨±</label><input type="text" class="form-control" v-model="newProduct.name" placeholder="ä¾‹å¦‚: è–¯æ¢" required></div><div class="mb-3"><label>SKU ç·¨è™Ÿ</label><input type="text" class="form-control" v-model="newProduct.sku" placeholder="ä¾‹å¦‚: CK-FRY-001" required></div><div class="mb-3"><label>åº«å­˜åŸºæº–å–®ä½</label><input type="text" class="form-control" v-model="newProduct.base_unit" placeholder="ä¾‹å¦‚: KG" required><div class="form-text">é€™æ˜¯ç¸½å€‰è¨˜å¸³ç”¨çš„æœ€å°å–®ä½</div></div><button type="submit" class="btn btn-primary w-100">å»ºç«‹å•†å“</button></form></div></div></div></div>

    <div class="modal fade" id="unitModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">è¨­å®šéŠ·å”®å–®ä½</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" v-if="selectedProduct"><h5 class="mb-3">æ­£åœ¨è¨­å®š: <span class="text-primary">{{ selectedProduct.name }}</span></h5><p class="small text-muted">åŸºæº–å–®ä½: {{ selectedProduct.base_unit }}</p><ul class="list-group mb-4"><li class="list-group-item d-flex justify-content-between align-items-center" v-for="u in productUnits" :key="u.id"><span><strong>{{ u.name }}</strong> (1{{ u.name }} = {{ u.rate }}{{ selectedProduct.base_unit }})</span><button class="btn btn-sm btn-outline-danger" @click="deleteUnit(u.id)">åˆªé™¤</button></li><li v-if="productUnits.length === 0" class="list-group-item text-center text-muted">æš«ç„¡å–®ä½ï¼Œåº—é•·ç„¡æ³•ä¸‹å–®</li></ul><hr><h6 class="fw-bold">æ–°å¢å–®ä½:</h6><div class="d-flex gap-2"><input type="text" class="form-control" placeholder="å–®ä½å (å¦‚: ç®±)" v-model="newUnit.name"><input type="number" class="form-control" placeholder="æ›ç®—ç‡ (å¦‚: 20)" v-model.number="newUnit.rate"><button class="btn btn-dark" @click="createUnit">æ–°å¢</button></div></div></div></div></div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/zh_tw.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                apiUrl: 'https://ä½ çš„-render-ç¶²å€.onrender.com/', // ğŸ”´ è¨˜å¾—æ”¹ç¶²å€
                currentTab: 'orders',
                
                // æ•¸æ“š
                orders: [], users: [], inventory: [], inventoryLogs: [], productUnits: [], productLogs: [],
                newUser: { username: '', password: '', display_name: '' },
                restockForm: { quantity: '', note: '' },
                newProduct: { name: '', sku: '', base_unit: '' },
                newUnit: { name: '', rate: '' },
                
                selectedProduct: null,
                selectedMonth: new Date().toISOString().slice(0, 7),
                
                // ç¯©é¸
                filters: { store: '', dateRange: '' },
                
                // å¯¦ä¾‹
                userModalInstance: null, restockModalInstance: null, newProductModalInstance: null, unitModalInstance: null, 
                flatpickrInstance: null, orderDateInstance: null
            }
        },
        mounted() {
            this.fetchUsers(); // è¼‰å…¥åˆ†åº—ä¾›ç¯©é¸ç”¨
            this.fetchOrders();
            
            // åˆå§‹åŒ– Modals
            this.userModalInstance = new bootstrap.Modal(document.getElementById('userModal'));
            this.restockModalInstance = new bootstrap.Modal(document.getElementById('restockModal'));
            this.newProductModalInstance = new bootstrap.Modal(document.getElementById('newProductModal'));
            this.unitModalInstance = new bootstrap.Modal(document.getElementById('unitModal'));

            // é¦–æ¬¡è¼‰å…¥éƒ½è¦åˆå§‹åŒ–ä¸€æ¬¡è¨‚å–®æ—¥æ›†
            this.initOrderCalendar();
        },
        methods: {
            // ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ‡æ› Tab æ™‚ï¼Œé‡æ–°ç¶å®šå°æ‡‰çš„æ—¥æ›†
            switchTab(tab) {
                this.currentTab = tab;
                
                // Case 1: åˆ‡æ›å›ã€Œè¨‚å–®ç´€éŒ„ã€
                if (tab === 'orders') {
                    this.$nextTick(() => {
                        this.initOrderCalendar(); // é‡æ–°å•Ÿå‹•è¨‚å–®æ—¥æ›†
                    });
                }
                
                // Case 2: åˆ‡æ›åˆ°ã€Œåˆ†åº—å¸³è™Ÿã€
                if (tab === 'users') {
                    this.fetchUsers();
                }
                
                // Case 3: åˆ‡æ›åˆ°ã€Œå€‰å„²ã€æˆ–ã€Œç”¢å“ã€
                if (tab === 'inventory' || tab === 'products') {
                    this.fetchInventory(); 
                    if(tab === 'products') this.fetchProductLogs();
                    
                    if(tab === 'inventory') {
                        this.fetchLogs();
                        // é‡æ–°å•Ÿå‹•å€‰å„²æœˆä»½æ—¥æ›†
                        this.$nextTick(() => {
                            if (this.flatpickrInstance) { this.flatpickrInstance.destroy(); this.flatpickrInstance = null; }
                            const pickerElement = document.getElementById("monthPicker");
                            if (pickerElement) {
                                this.flatpickrInstance = flatpickr(pickerElement, {
                                    locale: "zh_tw", defaultDate: this.selectedMonth, disableMobile: true,
                                    onChange: (d, s) => { this.selectedMonth = s.slice(0, 7); this.fetchLogs(); }
                                });
                            }
                        });
                    }
                }
            },
            
            // ç¨ç«‹æŠ½å‡ºã€Œåˆå§‹åŒ–è¨‚å–®æ—¥æ›†ã€çš„åŠŸèƒ½ï¼Œæ–¹ä¾¿é‡è¤‡ä½¿ç”¨
            initOrderCalendar() {
                // å…ˆéŠ·æ¯€èˆŠçš„ (å¦‚æœæœ‰)
                if (this.orderDateInstance) {
                    this.orderDateInstance.destroy();
                    this.orderDateInstance = null;
                }
                
                const element = document.getElementById("orderDatePicker");
                if (element) {
                    this.orderDateInstance = flatpickr(element, {
                        locale: "zh_tw",
                        mode: "range", 
                        dateFormat: "Y-m-d",
                        disableMobile: true,
                        defaultDate: this.filters.dateRange, // ä¿æŒç”¨æˆ¶å·²é¸çš„æ—¥æœŸ
                        onChange: (d, s) => { this.filters.dateRange = s; }
                    });
                }
            },

            // API calls
            async fetchOrders() {
                try {
                    let url = `${this.apiUrl}orders?`;
                    if (this.filters.store) url += `store=${encodeURIComponent(this.filters.store)}&`;
                    if (this.filters.dateRange) {
                        const dates = this.filters.dateRange.split(' to ');
                        if (dates.length >= 1) {
                            const start = dates[0];
                            const end = dates.length === 2 ? dates[1] : dates[0];
                            url += `start_date=${start}&end_date=${end}&`;
                        }
                    }
                    const r = await fetch(url);
                    this.orders = await r.json();
                } catch(e){}
            },
            resetFilters() {
                this.filters.store = '';
                this.filters.dateRange = '';
                if(this.orderDateInstance) this.orderDateInstance.clear();
                this.fetchOrders();
            },
            
            // å…¶ä»–åŸæœ‰åŠŸèƒ½ä¿æŒä¸è®Š
            async fetchUsers() { try { const r = await fetch(`${this.apiUrl}users`); this.users = await r.json(); } catch(e){} },
            async fetchInventory() { try { const r = await fetch(`${this.apiUrl}admin/products`); this.inventory = await r.json(); } catch(e){} },
            async fetchLogs() { try { const r = await fetch(`${this.apiUrl}admin/inventory_logs?month=${this.selectedMonth}`); this.inventoryLogs = await r.json(); } catch(e){} },
            async fetchUnits(pid) { try { const r = await fetch(`${this.apiUrl}admin/products/${pid}/units`); this.productUnits = await r.json(); } catch(e){} },
            async fetchProductLogs() { try { const r = await fetch(`${this.apiUrl}admin/product_logs`); this.productLogs = await r.json(); } catch(e){} },
            exportToExcel() {
                if (this.orders.length === 0) return;
                let csv = "\ufeffæ™‚é–“,ç·¨è™Ÿ,åˆ†åº—,å•†å“,æ•¸é‡,é‡é‡\n";
                this.orders.forEach(r => csv += `${r.time},${r.order_no},${r.store},${r.product},${r.qty},${r.total_weight}\n`);
                const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `è¨‚å–®å ±è¡¨.csv`; link.click();
            },
            
            // Actions
            async createUser() { try { const r = await fetch(`${this.apiUrl}create_user`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.newUser)}); if(r.ok){ this.userModalInstance.hide(); this.fetchUsers(); alert('æˆåŠŸ'); } else { alert('å¤±æ•—'); } } catch(e){} },
            async toggleUser(u) { if(confirm('ç¢ºå®š?')) { await fetch(`${this.apiUrl}users/${u.id}/toggle`, {method:'PUT'}); u.is_active=!u.is_active; } },
            async resetPassword(u) { if(confirm('é‡ç½®?')) { await fetch(`${this.apiUrl}users/${u.id}/reset_password`, {method:'PUT'}); alert('å·²é‡ç½®'); } },
            openRestockModal(p) { this.selectedProduct = p; this.restockForm={quantity:'', note:''}; this.restockModalInstance.show(); },
            async submitRestock() { if(!this.restockForm.quantity) return; try { const r = await fetch(`${this.apiUrl}restock`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({product_id:this.selectedProduct.id, quantity:this.restockForm.quantity, note:this.restockForm.note})}); if(r.ok) { this.restockModalInstance.hide(); this.fetchInventory(); if(this.currentTab==='inventory')this.fetchLogs(); alert('æˆåŠŸ'); } } catch(e){} },
            async createProduct() { try { const r = await fetch(`${this.apiUrl}admin/products/create`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.newProduct)}); if(r.ok) { this.newProductModalInstance.hide(); this.newProduct={name:'',sku:'',base_unit:''}; this.fetchInventory(); this.fetchProductLogs(); alert('æˆåŠŸå»ºç«‹'); } } catch(e){} },
            async toggleProduct(p) { if(!confirm(`ç¢ºå®šè¦${p.is_active!==false?'ä¸‹æ¶':'ä¸Šæ¶'}å—?`)) return; try { const r = await fetch(`${this.apiUrl}admin/products/${p.id}/toggle`, {method:'PUT'}); if(r.ok) { this.fetchInventory(); this.fetchProductLogs(); } } catch(e){} },
            openUnitModal(p) { this.selectedProduct = p; this.newUnit = {name:'', rate:''}; this.fetchUnits(p.id); this.unitModalInstance.show(); },
            async createUnit() { if(!this.newUnit.name || !this.newUnit.rate) return; try { const r = await fetch(`${this.apiUrl}admin/units/create`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({product_id:this.selectedProduct.id, unit_name:this.newUnit.name, conversion_rate:this.newUnit.rate})}); if(r.ok) { this.newUnit={name:'', rate:''}; this.fetchUnits(this.selectedProduct.id); this.fetchProductLogs(); } } catch(e){} },
            async deleteUnit(uid) { if(!confirm("ç¢ºå®šåˆªé™¤?")) return; try { const r = await fetch(`${this.apiUrl}admin/units/${uid}`, {method:'DELETE'}); if(r.ok) { this.fetchUnits(this.selectedProduct.id); this.fetchProductLogs(); } else { alert("å¤±æ•—"); } } catch(e){} }
        }
    }).mount('#app')
</script>
</body>
</html>