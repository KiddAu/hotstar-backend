<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±ªå¤§å¤§ - ç¸½éƒ¨ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', sans-serif; }
        .nav-tabs .nav-link.active { background-color: #fff; border-bottom-color: #fff; font-weight: bold; color: #0d6efd; }
        .nav-tabs .nav-link { color: #6c757d; cursor: pointer; }
        .table-card { background: white; border-radius: 0 0 10px 10px; border: 1px solid #dee2e6; border-top: none; }
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
        .kpi-card { border: none; border-radius: 12px; transition: transform 0.2s; color: white; }
        .kpi-card:hover { transform: translateY(-5px); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* è¨‚å–®åˆ—è¡¨æ¨£å¼ */
        .order-row { cursor: pointer; transition: background-color 0.1s; }
        .order-row:hover { background-color: #f1f7ff; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>

    <div v-if="!isLoggedIn" class="container">
        <div class="card shadow-lg mx-auto mt-5" style="max-width: 400px; border-radius: 15px;">
            <div class="card-body p-5 text-center">
                <h2 class="fw-bold mb-4">ğŸ— ç¸½éƒ¨ç™»å…¥</h2>
                <form @submit.prevent="login">
                    <input type="text" class="form-control mb-3" v-model="loginForm.username" placeholder="å¸³è™Ÿ" required>
                    <input type="password" class="form-control mb-4" v-model="loginForm.password" placeholder="å¯†ç¢¼" required>
                    <button type="submit" class="btn btn-primary w-100 py-2">ç™»å…¥</button>
                </form>
            </div>
        </div>
    </div>

    <div v-else class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-dark">ğŸ— è±ªå¤§å¤§ç¸½éƒ¨ç³»çµ±</h2>
            <div><span class="badge bg-success me-2">Admin: {{ adminName }}</span><button class="btn btn-outline-danger btn-sm" @click="logout">ç™»å‡º</button></div>
        </div>

        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'dashboard' }" @click="switchTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</a></li>
            <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'orders' }" @click="switchTab('orders')">ğŸ“‹ è¨‚å–®ç´€éŒ„</a></li>
            <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'users' }" @click="switchTab('users')">ğŸ‘¥ åˆ†åº—å¸³è™Ÿ</a></li>
            <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'inventory' }" @click="switchTab('inventory')">ğŸ“¦ å€‰å„²ç®¡ç†</a></li>
            <li class="nav-item"><a class="nav-link" :class="{ active: currentTab === 'products' }" @click="switchTab('products')">âš™ï¸ å•†å“é…ç½®</a></li>
        </ul>

        <div class="table-card p-4 shadow-sm bg-white">
            
            <div v-show="currentTab === 'dashboard'">
                
                <div class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="card kpi-card bg-primary p-3 shadow-sm h-100">
                            <h6 class="opacity-75">ğŸ“… æœ¬æœˆè¨‚å–®ç¸½æ•¸</h6>
                            <h2 class="fw-bold mb-0 display-6">{{ stats.kpi.total_orders }} <small class="fs-6">å–®</small></h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card kpi-card bg-success p-3 shadow-sm h-100">
                            <h6 class="opacity-75">ğŸšš æœ¬æœˆç¸½å‡ºè²¨é‡</h6>
                            <h2 class="fw-bold mb-0 display-6">{{ stats.kpi.total_weight }} <small class="fs-6">KG</small></h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card kpi-card bg-danger p-3 shadow-sm h-100">
                            <h6 class="opacity-75">âš ï¸ åº«å­˜å‘Šæ€¥ç”¢å“</h6>
                            <h2 class="fw-bold mb-0 display-6">{{ stats.kpi.low_stock_count }} <small class="fs-6">é …</small></h2>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="fw-bold text-dark mb-4">ğŸ“ˆ è¿‘ 14 æ—¥è¨‚å–®èµ°å‹¢</h5>
                                <div class="chart-container">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="fw-bold text-dark mb-4">ğŸ— æœ¬æœˆç†±è³£ Top 5 (KG)</h5>
                                <div class="chart-container">
                                    <canvas id="productChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="fw-bold text-dark mb-4">ğŸ† æœ¬æœˆæœ€å¸¸å«è²¨åˆ†åº— Top 5</h5>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="storeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div v-if="currentTab === 'orders'">
                <div class="card bg-light border-0 p-3 mb-3">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3"><select class="form-select" v-model="filters.store"><option value="">å…¨éƒ¨è±ªå¤§å¤§åˆ†åº—</option><option v-for="u in users" :key="u.id" :value="u.display_name">{{ u.display_name }}</option></select></div>
                        <div class="col-md-3"><input type="text" id="orderDatePicker" class="form-control bg-white" placeholder="å…¨éƒ¨æ—¥æœŸ" readonly></div>
                        <div class="col-md-auto ms-auto d-flex gap-2">
                            <button class="btn btn-primary" @click="fetchOrders">ğŸ” æœå°‹</button>
                            <button class="btn btn-outline-secondary" @click="resetFilters">é‡ç½®</button>
                            <div class="vr mx-1"></div>
                            <button class="btn btn-dark" @click="exportAllToExcel">ğŸ“‘ åŒ¯å‡ºç¸½è¡¨</button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ä¸‹å–®æ™‚é–“</th>
                                <th>è¨‚å–®ç·¨è™Ÿ</th>
                                <th>åˆ†åº—åç¨±</th>
                                <th>å…§å®¹æ‘˜è¦</th>
                                <th>ç¸½é‡é‡</th>
                                <th>ç‹€æ…‹</th>
                                <th class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in paginatedOrders" :key="order.order_no" class="order-row" @click="openOrderDetail(order)">
                                <td class="small text-muted">{{ order.time }}</td>
                                <td class="fw-bold text-primary small">{{ order.order_no }}</td>
                                <td>{{ order.store }}</td>
                                <td><span class="badge bg-secondary rounded-pill">{{ order.items_count }} é …å•†å“</span></td>
                                <td class="fw-bold text-dark">{{ order.total_weight }} KG</td>
                                <td><span class="badge bg-success">å·²ç¢ºèª</span></td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-success" @click.stop="exportSingleOrder(order)">
                                        ğŸ“¥ åŒ¯å‡ºæ­¤å–®
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="orders.length === 0"><td colspan="7" class="text-center text-muted py-4">æš«ç„¡è¨‚å–®</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination-container" v-if="orders.length > 0">
                    <span class="text-muted small">é¡¯ç¤º {{ (pages.orders - 1) * limits.orders + 1 }} - {{ Math.min(pages.orders * limits.orders, orders.length) }} ç­†</span>
                    <nav><ul class="pagination mb-0"><li class="page-item" :class="{ disabled: pages.orders === 1 }"><button class="page-link" @click="pages.orders--">ä¸Šä¸€é </button></li><li class="page-item disabled"><span class="page-link text-dark">{{ pages.orders }}</span></li><li class="page-item" :class="{ disabled: pages.orders >= Math.ceil(orders.length / limits.orders) }"><button class="page-link" @click="pages.orders++">ä¸‹ä¸€é </button></li></ul></nav>
                </div>
            </div>

            <div v-if="currentTab === 'users' || currentTab === 'inventory' || currentTab === 'products'">
                <div v-if="currentTab === 'users'">
                     <div class="d-flex justify-content-between mb-3"><p class="small text-muted">ç®¡ç†æ¬Šé™</p><button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#userModal">â• æ–°å¢</button></div>
                     <table class="table align-middle"><thead class="table-light"><tr><th>å¸³è™Ÿ</th><th>åˆ†åº—</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th><th>å¯†ç¢¼</th></tr></thead><tbody><tr v-for="u in paginatedUsers"><td>{{u.username}}</td><td>{{u.display_name}}</td><td>{{u.is_active?'æ­£å¸¸':'åœç”¨'}}</td><td><button class="btn btn-sm" @click="toggleUser(u)">åˆ‡æ›</button></td><td><button class="btn btn-sm" @click="resetPassword(u)">é‡ç½®</button></td></tr></tbody></table>
                </div>
                
                <div v-if="currentTab === 'inventory'">
                    <div class="d-flex justify-content-between mb-3"><p class="small text-muted">åº«å­˜ç®¡ç†</p><button class="btn btn-primary btn-sm" @click="fetchInventory">åˆ·æ–°</button></div>
                    <table class="table align-middle table-bordered"><thead class="table-light"><tr><th>SKU</th><th>å•†å“</th><th>åº«å­˜</th><th>å–®ä½</th><th>æ“ä½œ</th></tr></thead><tbody><tr v-for="i in paginatedInventory"><td>{{i.sku}}</td><td>{{i.name}}</td><td>{{i.current_stock}}</td><td>{{i.base_unit}}</td><td><button class="btn btn-sm btn-outline-primary" @click="openRestockModal(i)">èª¿æ•´</button></td></tr></tbody></table>
                    <hr class="my-4">
                    <div class="d-flex align-items-center mb-3"><label class="me-2 fw-bold">æ—¥æœŸç¯„åœ:</label><input type="text" id="logDatePicker" class="form-control" placeholder="é¸æ“‡ç¯„åœ" style="width: 250px;"></div>
                    <table class="table table-striped"><thead><tr><th>æ™‚é–“</th><th>å•†å“</th><th>è®Šå‹•</th><th>å‚™è¨»</th></tr></thead><tbody><tr v-for="l in paginatedLogs"><td>{{l.time}}</td><td>{{l.product}}</td><td>{{l.qty}}</td><td>{{l.note}}</td></tr></tbody></table>
                </div>

                <div v-if="currentTab === 'products'">
                    <div class="d-flex justify-content-between mb-3"><div class="alert alert-info py-2 mb-0 small">å•†å“è¨­å®š</div><button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newProductModal">æ–°å¢</button></div>
                    <table class="table align-middle"><thead class="table-light"><tr><th>SKU</th><th>å•†å“</th><th>Base</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody><tr v-for="i in paginatedConfigProducts"><td>{{i.sku}}</td><td>{{i.name}}</td><td>{{i.base_unit}}</td><td>{{i.is_active!==false?'ä¸Šæ¶':'ä¸‹æ¶'}}</td><td><button class="btn btn-sm btn-outline-dark me-2" @click="openUnitModal(i)">å–®ä½</button><button class="btn btn-sm" @click="toggleProduct(i)">ä¸Šä¸‹æ¶</button></td></tr></tbody></table>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">ğŸ“œ è¨‚å–®è©³æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" v-if="selectedOrder">
                    <div class="row mb-4">
                        <div class="col-6"><strong>å–®è™Ÿï¼š</strong> {{ selectedOrder.order_no }}</div>
                        <div class="col-6 text-end"><strong>æ™‚é–“ï¼š</strong> {{ selectedOrder.time }}</div>
                        <div class="col-6"><strong>åˆ†åº—ï¼š</strong> <span class="badge bg-dark">{{ selectedOrder.store }}</span></div>
                        <div class="col-6 text-end"><strong>ç‹€æ…‹ï¼š</strong> <span class="badge bg-success">APPROVED</span></div>
                    </div>
                    
                    <table class="table table-bordered align-middle">
                        <thead class="table-secondary"><tr><th>å•†å“åç¨±</th><th>è¨‚è³¼æ•¸é‡</th><th>æ‰£å€‰é‡é‡</th></tr></thead>
                        <tbody>
                            <tr v-for="item in selectedOrder.items">
                                <td>{{ item.product }}</td>
                                <td class="fw-bold">{{ item.qty }}</td>
                                <td class="text-muted">{{ item.weight }} KG</td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="2" class="text-end fw-bold">ç¸½é‡é‡ï¼š</td>
                                <td class="fw-bold text-danger">{{ selectedOrder.total_weight }} KG</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" @click="exportSingleOrder(selectedOrder)">ğŸ“¥ åŒ¯å‡ºæ­¤å–® (Excel)</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">æ–°å¢å¸³è™Ÿ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="createUser"><div class="mb-3"><label>å¸³è™Ÿ</label><input type="text" class="form-control" v-model="newUser.username" required></div><div class="mb-3"><label>åˆ†åº—å</label><input type="text" class="form-control" v-model="newUser.display_name" required></div><div class="mb-3"><label>å¯†ç¢¼</label><input type="text" class="form-control" v-model="newUser.password" required></div><button type="submit" class="btn btn-dark w-100">å»ºç«‹</button></form></div></div></div></div>
    <div class="modal fade" id="restockModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">åº«å­˜èª¿æ•´</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" v-if="selectedProduct"><h5 class="fw-bold">{{ selectedProduct.name }}</h5><p>ç›®å‰: {{ selectedProduct.current_stock }} {{ selectedProduct.base_unit }}</p><form @submit.prevent="submitRestock"><div class="mb-3"><label>æ•¸é‡ ({{ selectedProduct.base_unit }})</label><input type="number" step="0.01" class="form-control" v-model.number="restockForm.quantity" placeholder="æ­£æ•¸å…¥è²¨ï¼Œè² æ•¸æ‰£æ¸›" required></div><div class="mb-3"><label>å‚™è¨»</label><input type="text" class="form-control" v-model="restockForm.note"></div><button type="submit" class="btn btn-primary w-100">ç¢ºèª</button></form></div></div></div></div>
    <div class="modal fade" id="newProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">æ–°å¢å•†å“</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="createProduct"><div class="mb-3"><label>åç¨±</label><input type="text" class="form-control" v-model="newProduct.name" required></div><div class="mb-3"><label>SKU</label><input type="text" class="form-control" v-model="newProduct.sku" required></div><div class="mb-3"><label>Base Unit</label><input type="text" class="form-control" v-model="newProduct.base_unit" required></div><button type="submit" class="btn btn-primary w-100">å»ºç«‹</button></form></div></div></div></div>
    <div class="modal fade" id="unitModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">è¨­å®šå–®ä½</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" v-if="selectedProduct"><ul class="list-group mb-4"><li class="list-group-item d-flex justify-content-between" v-for="u in productUnits" :key="u.id"><span>{{ u.name }} = {{ u.rate }}</span><button class="btn btn-sm btn-outline-danger" @click="deleteUnit(u.id)">X</button></li></ul><div class="d-flex gap-2"><input class="form-control" placeholder="å–®ä½" v-model="newUnit.name"><input class="form-control" placeholder="ç‡" v-model.number="newUnit.rate"><button class="btn btn-dark" @click="createUnit">+</button></div></div></div></div></div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/zh_tw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                apiUrl: 'https://hotstar-api.onrender.com/', // ğŸ”´ è«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢º
                isLoggedIn: false, adminToken: '', adminName: '', 
                loginForm: { username: '', password: '' }, 
                loading: false, globalLoading: false,
                currentTab: 'dashboard',
                
                // Data
                stats: { kpi: { total_orders: 0, total_weight: 0, low_stock_count: 0 }, trend: { labels: [], values: [] }, top_products: { labels: [], values: [] }, top_stores: { labels: [], values: [] } },
                orders: [], users: [], inventory: [], inventoryLogs: [], productUnits: [], productLogs: [],
                newUser: { username: '', password: '', display_name: '' }, 
                restockForm: { quantity: '', note: '' }, 
                newProduct: { name: '', sku: '', base_unit: '' }, 
                newUnit: { name: '', rate: '' },
                
                selectedProduct: null, 
                selectedOrder: null, 
                selectedMonth: new Date().toISOString().slice(0, 7),
                filters: { store: '', dateRange: '', logDateRange: '' },
                
                pages: { orders: 1, users: 1, inventory: 1, logs: 1, configProducts: 1, configLogs: 1 },
                limits: { orders: 30, users: 10, inventory: 10, logs: 20, configProducts: 10, configLogs: 50 },

                // Instances
                userModalInstance: null, restockModalInstance: null, newProductModalInstance: null, unitModalInstance: null, orderDetailModalInstance: null,
                flatpickrInstance: null, orderDateInstance: null, charts: { trend: null, product: null, store: null }
            }
        },
        computed: {
            paginatedOrders() { return this.paginate(this.orders, this.pages.orders, this.limits.orders); },
            paginatedUsers() { return this.paginate(this.users, this.pages.users, this.limits.users); },
            paginatedInventory() { return this.paginate(this.inventory, this.pages.inventory, this.limits.inventory); },
            paginatedLogs() { return this.paginate(this.inventoryLogs, this.pages.logs, this.limits.logs); },
            paginatedConfigProducts() { return this.paginate(this.inventory, this.pages.configProducts, this.limits.configProducts); },
            paginatedConfigLogs() { return this.paginate(this.productLogs, this.pages.configLogs, this.limits.configLogs); }
        },
        mounted() {
            const t = localStorage.getItem('adminToken');
            if(t) { 
                this.adminToken = t; 
                this.adminName = localStorage.getItem('adminName'); 
                this.isLoggedIn = true; 
                this.initApp(); 
            }
        },
        methods: {
            // --- æ ¸å¿ƒï¼šTab åˆ‡æ›é‚è¼¯ ---
            switchTab(tab) {
                this.currentTab = tab;
                
                // 1. Dashboard
                if (tab === 'dashboard') { 
                    this.fetchDashboardStats(); 
                }
                
                // 2. è¨‚å–®ç´€éŒ„
                if (tab === 'orders') { 
                    this.$nextTick(() => { this.initOrderCalendar(); }); 
                }
                
                // 3. åˆ†åº—å¸³è™Ÿ
                if (tab === 'users') { 
                    this.fetchUsers(); 
                }
                
                // 4. å€‰å„² & ç”¢å“é…ç½®
                if (tab === 'inventory' || tab === 'products') {
                    this.fetchInventory(); 
                    
                    if(tab === 'products') {
                        this.fetchProductLogs();
                    }
                    
                    if(tab === 'inventory') {
                        if(!this.filters.logDateRange) this.fetchLogs();
                        
                        this.$nextTick(() => {
                            if (this.flatpickrInstance) { this.flatpickrInstance.destroy(); this.flatpickrInstance = null; }
                            const pickerElement = document.getElementById("logDatePicker");
                            if (pickerElement) {
                                this.flatpickrInstance = flatpickr(pickerElement, { 
                                    locale: "zh_tw", 
                                    mode: "range", 
                                    dateFormat: "Y-m-d", 
                                    disableMobile: true, 
                                    defaultDate: this.filters.logDateRange, 
                                    onChange: (d, s) => { this.filters.logDateRange = s; this.fetchLogs(); } 
                                });
                            }
                        });
                    }
                }
            },

            // --- Auth ---
            async authFetch(url, opt={}) { 
                if(!opt.headers) opt.headers={}; 
                opt.headers['Authorization']=`Bearer ${this.adminToken}`; 
                try{ 
                    const r=await fetch(url,opt); 
                    if(r.status===401){ this.logout(); return null; } 
                    return r; 
                } catch(e){ return null; } 
            },
            async login() { 
                const f=new FormData(); 
                f.append('username',this.loginForm.username); 
                f.append('password',this.loginForm.password); 
                try {
                    const r=await fetch(`${this.apiUrl}admin/login`,{method:'POST',body:f}); 
                    if(r.ok){ 
                        const d=await r.json(); 
                        this.adminToken=d.access_token; 
                        this.adminName=this.loginForm.username; 
                        this.isLoggedIn=true; 
                        localStorage.setItem('adminToken',d.access_token); 
                        localStorage.setItem('adminName',this.adminName); 
                        this.initApp(); 
                    } else { alert('ç™»å…¥å¤±æ•—'); }
                } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
            },
            logout() { this.isLoggedIn=false; localStorage.clear(); },
            
            initApp() {
                this.$nextTick(() => {
                    this.fetchDashboardStats(); 
                    this.fetchUsers(); 
                    this.fetchOrders();
                    
                    this.userModalInstance=new bootstrap.Modal(document.getElementById('userModal'));
                    this.restockModalInstance=new bootstrap.Modal(document.getElementById('restockModal'));
                    this.newProductModalInstance=new bootstrap.Modal(document.getElementById('newProductModal'));
                    this.unitModalInstance=new bootstrap.Modal(document.getElementById('unitModal'));
                    this.orderDetailModalInstance=new bootstrap.Modal(document.getElementById('orderDetailModal'));
                    
                    this.initOrderCalendar();
                });
            },

            // --- æ•¸æ“š Fetching ---
            async fetchDashboardStats() { const r = await this.authFetch(`${this.apiUrl}admin/dashboard_stats`); if(r) { this.stats = await r.json(); this.$nextTick(() => { this.renderCharts(); }); } },
            async fetchOrders() { 
                try { 
                    let url = `${this.apiUrl}orders?`; 
                    if (this.filters.store) url += `store=${encodeURIComponent(this.filters.store)}&`; 
                    if (this.filters.dateRange) { const d = this.filters.dateRange.split(' to '); if (d.length >= 1) url += `start_date=${d[0]}&end_date=${d.length===2?d[1]:d[0]}&`; } 
                    const r = await this.authFetch(url); 
                    if(r) { this.orders = await r.json(); this.pages.orders = 1; } 
                } catch(e){} 
            },
            resetFilters() { this.filters.store = ''; this.filters.dateRange = ''; if(this.orderDateInstance) this.orderDateInstance.clear(); this.fetchOrders(); },
            
            async fetchUsers() { const r = await this.authFetch(`${this.apiUrl}users`); if(r) { this.users = await r.json(); this.pages.users = 1; } },
            async fetchInventory() { const r = await this.authFetch(`${this.apiUrl}admin/products`); if(r) { this.inventory = await r.json(); this.pages.inventory = 1; this.pages.configProducts = 1; } },
            async fetchLogs() { 
                let url = `${this.apiUrl}admin/inventory_logs?`; 
                if (this.filters.logDateRange) { const d = this.filters.logDateRange.split(' to '); if (d.length >= 1) url += `start_date=${d[0]}&end_date=${d.length===2?d[1]:d[0]}&`; } 
                const r = await this.authFetch(url); if(r) { this.inventoryLogs = await r.json(); this.pages.logs = 1; } 
            },
            async fetchProductLogs() { const r = await this.authFetch(`${this.apiUrl}admin/product_logs`); if(r) { this.productLogs = await r.json(); this.pages.configLogs = 1; } },
            async fetchUnits(pid) { const r = await this.authFetch(`${this.apiUrl}admin/products/${pid}/units`); if(r) { this.productUnits = await r.json(); } },

            // --- å¯«å…¥æ“ä½œ ---
            async createUser() { const r = await this.authFetch(`${this.apiUrl}create_user`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.newUser)}); if(r && r.ok){ this.userModalInstance.hide(); this.fetchUsers(); alert('æˆåŠŸ'); } },
            async toggleUser(u) { if(confirm('ç¢ºå®š?')) { const r = await this.authFetch(`${this.apiUrl}users/${u.id}/toggle`, {method:'PUT'}); if(r && r.ok) u.is_active=!u.is_active; } },
            async resetPassword(u) { if(confirm('é‡ç½®?')) { const r = await this.authFetch(`${this.apiUrl}users/${u.id}/reset_password`, {method:'PUT'}); if(r && r.ok) alert('å·²é‡ç½®'); } },
            openRestockModal(p) { this.selectedProduct = p; this.restockForm={quantity:'', note:''}; this.restockModalInstance.show(); },
            async submitRestock() { if(!this.restockForm.quantity) return; const r = await this.authFetch(`${this.apiUrl}restock`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({product_id:this.selectedProduct.id, quantity:this.restockForm.quantity, note:this.restockForm.note})}); if(r && r.ok) { this.restockModalInstance.hide(); this.fetchInventory(); if(this.currentTab==='inventory')this.fetchLogs(); alert('æˆåŠŸ'); } },
            async createProduct() { const r = await this.authFetch(`${this.apiUrl}admin/products/create`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.newProduct)}); if(r && r.ok) { this.newProductModalInstance.hide(); this.newProduct={name:'',sku:'',base_unit:''}; this.fetchInventory(); this.fetchProductLogs(); alert('æˆåŠŸ'); } },
            async toggleProduct(p) { if(!confirm('ç¢ºå®š?')) return; const r = await this.authFetch(`${this.apiUrl}admin/products/${p.id}/toggle`, {method:'PUT'}); if(r && r.ok) { this.fetchInventory(); this.fetchProductLogs(); } },
            openUnitModal(p) { this.selectedProduct = p; this.newUnit = {name:'', rate:''}; this.fetchUnits(p.id); this.unitModalInstance.show(); },
            async createUnit() { if(!this.newUnit.name) return; const r = await this.authFetch(`${this.apiUrl}admin/units/create`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({product_id:this.selectedProduct.id, unit_name:this.newUnit.name, conversion_rate:this.newUnit.rate})}); if(r && r.ok) { this.newUnit={name:'', rate:''}; this.fetchUnits(this.selectedProduct.id); this.fetchProductLogs(); } },
            async deleteUnit(uid) { if(!confirm("åˆªé™¤?")) return; const r = await this.authFetch(`${this.apiUrl}admin/units/${uid}`, {method:'DELETE'}); if(r && r.ok) { this.fetchUnits(this.selectedProduct.id); this.fetchProductLogs(); } },

            // --- å·¥å…· ---
            paginate(items, page, limit) { const start = (page - 1) * limit; return items.slice(start, start + limit); },
            initOrderCalendar() { if (this.orderDateInstance) { this.orderDateInstance.destroy(); this.orderDateInstance = null; } const element = document.getElementById("orderDatePicker"); if (element) { this.orderDateInstance = flatpickr(element, { locale: "zh_tw", mode: "range", dateFormat: "Y-m-d", disableMobile: true, defaultDate: this.filters.dateRange, onChange: (d, s) => { this.filters.dateRange = s; } }); } },
            
            // Modal & Export
            openOrderDetail(order) { this.selectedOrder = order; this.orderDetailModalInstance.show(); },
            exportSingleOrder(order) {
                let csv = "\ufeffå•†å“åç¨±,è¨‚è³¼æ•¸é‡,æ‰£å€‰é‡é‡\n";
                order.items.forEach(item => { csv += `${item.product},${item.qty},${item.weight} KG\n`; });
                csv += `\n,,ç¸½é‡é‡: ${order.total_weight} KG`;
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${order.order_no}.csv`; link.click();
            },
            exportAllToExcel() {
                if (this.orders.length === 0) return;
                let csv = "\ufeffè¨‚å–®æ™‚é–“,å–®è™Ÿ,åˆ†åº—,ç¸½ä»¶æ•¸,ç¸½é‡é‡,è©³ç´°å…§å®¹\n";
                this.orders.forEach(o => {
                    let details = o.items.map(i => `${i.product} x${i.qty}`).join(" | ");
                    csv += `${o.time},${o.order_no},${o.store},${o.items_count},${o.total_weight},${details}\n`;
                });
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `è¨‚å–®ç¸½è¡¨.csv`; link.click();
            },

            // Charts
            renderCharts() {
                if(this.charts.trend) this.charts.trend.destroy();
                this.charts.trend = new Chart(document.getElementById('trendChart'), { type: 'line', data: { labels: this.stats.trend.labels, datasets: [{ label: 'æ¯æ—¥è¨‚å–®æ•¸', data: this.stats.trend.values, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                if(this.charts.product) this.charts.product.destroy();
                this.charts.product = new Chart(document.getElementById('productChart'), { type: 'doughnut', data: { labels: this.stats.top_products.labels, datasets: [{ data: this.stats.top_products.values, backgroundColor: ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                if(this.charts.store) this.charts.store.destroy();
                this.charts.store = new Chart(document.getElementById('storeChart'), { type: 'bar', data: { labels: this.stats.top_stores.labels, datasets: [{ label: 'è¨‚å–®æ•¸', data: this.stats.top_stores.values, backgroundColor: '#198754', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
            }
        }
    }).mount('#app')
</script>
</body>
</html>