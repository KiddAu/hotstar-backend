<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±ªå¤§å¤§ - åˆ†åº—è¨‚è²¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom: 70px; }
        
        /* ç™»å…¥å¡ç‰‡ */
        .login-card { max-width: 400px; margin: 60px auto; border-radius: 20px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.08); background: white; padding: 2rem; }

        /* å•†å“å¡ç‰‡ */
        .product-card { border: none; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); background: white; margin-bottom: 10px; }
        .qty-btn { width: 30px; height: 30px; padding: 0; border-radius: 50%; font-weight: bold; }
        
        /* æ­·å²è¨‚å–®å¡ç‰‡ */
        .history-card { border: none; border-radius: 12px; background: white; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid #0d6efd; }
        
        /* åº•éƒ¨å°èˆªæ¬„ (Bottom Tab Bar) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item { text-align: center; color: #adb5bd; font-size: 0.8rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }

        /* é è¨ˆé€è²¨ Banner */
        .delivery-banner { background-color: #e7f1ff; color: #0c5460; padding: 10px 15px; font-size: 0.9rem; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b8daff; display: flex; align-items: center; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>

    <div v-if="!currentUser" class="container px-3">
        <div class="login-card text-center">
            <h1 style="font-size: 3rem;">ğŸ—</h1>
            <h3 class="fw-bold text-dark mb-1">è±ªå¤§å¤§ç‚¸é›</h3>
            <p class="text-muted mb-4">åˆ†åº—è¨‚è²¨ç³»çµ± v3.0</p>
            <form @submit.prevent="handleLogin">
                <div class="form-floating mb-3 text-start"><input type="text" class="form-control" id="uid" v-model="loginForm.username" placeholder="å¸³è™Ÿ" required><label for="uid">åˆ†åº—å¸³è™Ÿ (ID)</label></div>
                <div class="form-floating mb-4 text-start"><input type="password" class="form-control" id="pwd" v-model="loginForm.password" placeholder="å¯†ç¢¼" required><label for="pwd">å¯†ç¢¼</label></div>
                <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5" :disabled="loading">{{ loading ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥ç³»çµ±' }}</button>
            </form>
        </div>
    </div>

    <div v-else-if="currentUser.is_reset_needed" class="container px-3 pt-5">
        <div class="login-card border-warning border-top border-5">
            <h4 class="fw-bold text-center">âš ï¸ å®‰å…¨æç¤º</h4>
            <p class="text-muted small text-center mb-4">è«‹è¨­å®šæ–°å¯†ç¢¼ä»¥ç¹¼çºŒä½¿ç”¨ã€‚</p>
            <form @submit.prevent="handleChangePassword">
                <input type="password" class="form-control form-control-lg mb-3" v-model="newPassword" placeholder="æ–°å¯†ç¢¼" required>
                <button type="submit" class="btn btn-warning w-100 py-2 fw-bold">ç¢ºèªä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <div v-else class="container pt-3">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0 text-dark">{{ currentUser.display_name }}</h5>
            <button class="btn btn-sm btn-light text-danger" @click="logout">ç™»å‡º</button>
        </div>

        <div v-if="currentTab === 'order'" class="delivery-banner shadow-sm">
            <span style="font-size: 1.2rem; margin-right: 10px;">ğŸš›</span>
            <div>
                <strong>é è¨ˆé€è²¨ï¼š</strong> {{ estimatedDelivery }}
                <div style="font-size: 0.75rem; opacity: 0.8;">(æˆªå–®æ™‚é–“ 14:00ï¼Œé€¾æ™‚å¾Œå¤©é€é”)</div>
            </div>
        </div>

        <div v-if="currentTab === 'order'">
            <div v-if="loadingProducts" class="text-center my-5"><div class="spinner-border text-primary" role="status"></div></div>
            
            <div v-else>
                <div class="row g-2">
                    <div class="col-12" v-for="item in products" :key="item.unit_id">
                        <div class="card product-card p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-1">{{ item.product_name }}</h6>
                                    <span class="badge bg-light text-dark border">{{ item.selling_unit }} ({{ item.rate }}{{ item.base_unit }})</span>
                                </div>
                                
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary qty-btn d-flex align-items-center justify-content-center" 
                                        @click="item.orderQty = (item.orderQty > 0 ? item.orderQty - 1 : 0)" 
                                        :disabled="!item.orderQty || item.orderQty <= 0">-</button>
                                    
                                    <input type="number" class="form-control form-control-sm border-0 text-center fw-bold mx-1" 
                                           style="width: 50px; font-size: 1.1rem;" 
                                           v-model.number="item.orderQty" placeholder="0" min="0">
                                    
                                    <button class="btn btn-primary qty-btn d-flex align-items-center justify-content-center" 
                                        @click="item.orderQty = (item.orderQty || 0) + 1">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fixed-bottom p-3" style="bottom: 60px; z-index: 990;" v-if="cartTotalQty > 0">
                    <button class="btn btn-primary w-100 py-3 rounded-pill shadow fw-bold fs-5" @click="placeOrder">
                        ç¢ºèªä¸‹å–® ({{ cartTotalQty }} ä»¶)
                    </button>
                </div>
                <div v-else class="text-center text-muted mt-5 py-5">
                    <p>è«‹é¸æ“‡å•†å“æ•¸é‡</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'history'">
            <h5 class="fw-bold mb-3">ğŸ“¦ æœ€è¿‘ 20 ç­†è¨‚å–®</h5>
            <div v-if="loadingHistory" class="text-center my-5"><div class="spinner-border text-secondary" role="status"></div></div>
            
            <div v-else>
                <div v-for="order in orderHistory" :key="order.order_no" class="card history-card p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="fw-bold text-dark">{{ order.date }}</div>
                            <div class="text-muted small">{{ order.order_no }}</div>
                        </div>
                        <span class="badge bg-success">å·²ç¢ºèª</span>
                    </div>
                    
                    <div class="bg-light p-2 rounded mb-3 small">
                        <div v-for="item in order.items" class="d-flex justify-content-between">
                            <span>{{ item.product_name }}</span>
                            <span class="fw-bold">x {{ item.qty }} {{ item.unit_name }}</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-primary w-100 btn-sm fw-bold" @click="quickReorder(order)">
                        ğŸ”„ ç…§å–®å†è²· (Quick Reorder)
                    </button>
                </div>
                <div v-if="orderHistory.length === 0" class="text-center text-muted py-5">æš«ç„¡æ­·å²è¨‚å–®</div>
            </div>
        </div>

    </div>

    <div v-if="currentUser && !currentUser.is_reset_needed" class="bottom-nav">
        <div class="nav-item" :class="{ active: currentTab === 'order' }" @click="currentTab = 'order'">
            <span class="nav-icon">ğŸ›’</span>
            ä¸‹å–®
        </div>
        <div class="nav-item" :class="{ active: currentTab === 'history' }" @click="switchTab('history')">
            <span class="nav-icon">ğŸ“œ</span>
            ç´€éŒ„
        </div>
    </div>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100;">
        <div id="liveToast" class="toast align-items-center text-white border-0 shadow" :class="toastClass" role="alert"><div class="d-flex"><div class="toast-body text-center w-100 fw-bold">{{ toastMessage }}</div></div></div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                apiUrl: 'https://hotstar-api.onrender.com/', // ğŸ”´ è¨˜å¾—æ”¹ç¶²å€ï¼
                
                currentUser: null,
                loginForm: { username: '', password: '' },
                newPassword: '',
                
                currentTab: 'order', // order | history
                products: [],
                orderHistory: [],
                
                loading: false,
                loadingProducts: false,
                loadingHistory: false,
                
                toastMessage: '', toastClass: 'bg-success', toastInstance: null
            }
        },
        computed: {
            // è¨ˆç®—è³¼ç‰©è»Šç¸½ä»¶æ•¸
            cartTotalQty() {
                return this.products.reduce((sum, item) => sum + (item.orderQty || 0), 0);
            },
            // è¨ˆç®—é è¨ˆé€è²¨æ™‚é–“
            estimatedDelivery() {
                const now = new Date();
                const hour = now.getHours();
                // é‚è¼¯ï¼šä¸‹åˆ 2 é»å‰ä¸‹å–® -> æ˜å¤©é€ï¼›2 é»å¾Œ -> å¾Œå¤©é€
                let deliveryDate = new Date();
                if (hour < 14) {
                    deliveryDate.setDate(now.getDate() + 1); // æ˜å¤©
                } else {
                    deliveryDate.setDate(now.getDate() + 2); // å¾Œå¤©
                }
                const day = deliveryDate.getDate();
                const month = deliveryDate.getMonth() + 1;
                return `${month}æœˆ${day}æ—¥ ä¸‹åˆ`;
            }
        },
        mounted() {
            this.toastInstance = new bootstrap.Toast(document.getElementById('liveToast'), { delay: 2000 });
            const savedUser = localStorage.getItem('storeUser');
            if (savedUser) {
                this.currentUser = JSON.parse(savedUser);
                if (!this.currentUser.is_reset_needed) this.fetchProducts();
            }
        },
        methods: {
            switchTab(tab) {
                this.currentTab = tab;
                if (tab === 'history') this.fetchHistory();
            },

            // 1. ç²å–ç”¢å“ (ä¸‹å–®ç”¨)
            async fetchProducts() {
                this.loadingProducts = true;
                try {
                    const r = await fetch(`${this.apiUrl}products`);
                    const data = await r.json();
                    // ä¿ç•™å·²è¼¸å…¥çš„æ•¸é‡ (å¦‚æœåˆ‡æ› Tab å›ä¾†)
                    this.products = data.map(newItem => {
                        const existing = this.products.find(p => p.unit_id === newItem.unit_id);
                        return { ...newItem, orderQty: existing ? existing.orderQty : null };
                    });
                } catch(e) { this.showToast('ç„¡æ³•é€£ç·š', 'bg-danger'); } 
                finally { this.loadingProducts = false; }
            },

            // 2. ç²å–æ­·å²ç´€éŒ„
            async fetchHistory() {
                this.loadingHistory = true;
                try {
                    // éœ€è¦ Token
                    const r = await fetch(`${this.apiUrl}store/my_orders`, {
                        headers: { 'Authorization': `Bearer ${JSON.parse(localStorage.getItem('storeToken'))}` }
                    });
                    if(r.ok) this.orderHistory = await r.json();
                } catch(e) {} finally { this.loadingHistory = false; }
            },

            // 3. ç…§å–®å†è²· (Quick Reorder) æ ¸å¿ƒé‚è¼¯
            quickReorder(pastOrder) {
                // æ¸…ç©ºç•¶å‰è³¼ç‰©è»Š
                this.products.forEach(p => p.orderQty = null);
                
                let matchCount = 0;
                // éæ­·èˆŠå–®ï¼Œå¡«å…¥æ–°å–®
                pastOrder.items.forEach(oldItem => {
                    // æ ¹æ“š unit_id åŒ¹é…
                    const target = this.products.find(p => p.unit_id === oldItem.unit_id);
                    if (target) {
                        target.orderQty = oldItem.qty;
                        matchCount++;
                    }
                });

                if (matchCount > 0) {
                    this.currentTab = 'order'; // è·³å›ä¸‹å–®é 
                    this.showToast(`å·²è¼‰å…¥ ${matchCount} é …å•†å“`, 'bg-success');
                } else {
                    this.showToast('å•†å“å·²ä¸‹æ¶æˆ–ç„¡æ³•åŒ¹é…', 'bg-warning');
                }
            },

            // 4. ä¸‹å–® (å·²å‡ç´šï¼šæ‰¹é‡ç™¼é€)
            async placeOrder() {
                const itemsToBuy = this.products.filter(p => p.orderQty > 0);
                if (itemsToBuy.length === 0) return;

                this.showToast('æ­£åœ¨æäº¤è¨‚å–®...', 'bg-info');

                // æº–å‚™æ‰¹é‡æ•¸æ“š
                // æˆ‘å€‘åªéœ€è¦å‚³ unit_id å’Œ quantityï¼Œå¾Œç«¯æœƒè‡ªå·±æŸ¥ product_id
                const payload = {
                    store_name: this.currentUser.display_name,
                    items: itemsToBuy.map(item => ({
                        unit_id: item.unit_id,
                        quantity: item.orderQty
                    }))
                };
                
                try {
                    const response = await fetch(`${this.apiUrl}order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();

                    if (response.ok) {
                        this.showToast(`âœ… ä¸‹å–®æˆåŠŸï¼åŒ…å« ${itemsToBuy.length} é …å•†å“`, 'bg-success');
                        // æ¸…ç©ºè³¼ç‰©è»Š
                        this.products.forEach(p => p.orderQty = null);
                        // åˆ‡æ›å»ç´€éŒ„é ç‡ä¸‹
                        setTimeout(() => { this.switchTab('history'); }, 1000);
                    } else {
                        this.showToast(`âŒ å¤±æ•—: ${result.detail}`, 'bg-danger');
                    }
                } catch (error) {
                    this.showToast(`âŒ é€£ç·šéŒ¯èª¤`, 'bg-danger');
                }
            },

            // ... Auth ç›¸é—œ (ä¿æŒä¸è®Š) ...
            async handleLogin() {
                this.loading = true;
                try {
                    const res = await fetch(`${this.apiUrl}admin/login`, { // æ³¨æ„ï¼šStore login å…¶å¯¦å¯ä»¥ç”¨åŒä¸€å€‹ Endpoint å¦‚æœä½ å¾Œç«¯æ²’åˆ†é–‹
                        // ä¿®æ­£ï¼šæˆ‘å€‘ä¹‹å‰å¯«çš„æ˜¯ admin/loginï¼Œå¾Œç«¯ logic æŸ¥çš„æ˜¯ admin_users table
                        // æˆ‘å€‘éœ€è¦ä¸€å€‹åˆ†åº—ç”¨çš„ loginã€‚
                        // æš«æ™‚ï¼šæˆ‘å€‘åœ¨ main.py å¯«ä¸€å€‹é€šç”¨ login æŸ¥ store_users? 
                        // æˆ–è€…ï¼šç”¨å›æˆ‘å€‘åœ¨ Store App v1.0 çš„é‚£å€‹ login (åŠŸèƒ½ #8)
                        // è®“æˆ‘å€‘ç”¨ /login (åŠŸèƒ½ #8)
                    });
                    
                    // ä¿®æ­£ï¼šStore Login API æ˜¯ /login
                    const r = await fetch(`${this.apiUrl}login`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.loginForm)
                    });
                    const data = await r.json();
                    
                    if (r.ok) {
                        this.currentUser = data.user;
                        // Store API æ²’å›å‚³ tokenï¼Œæ‰€ä»¥é€™è£¡æˆ‘å€‘åªå­˜ User Object
                        // ä½†ç‚ºäº† fetchHistory éœ€è¦ Tokenï¼Œæˆ‘å€‘å¯èƒ½éœ€è¦å¾Œç«¯ /login ä¹Ÿå›å‚³ Token
                        // æš«æ™‚ Hack: ç”±æ–¼ /login æ²’å›å‚³ Token (åªå›å‚³ user info)ï¼ŒfetchHistory å¯èƒ½æœƒ 401
                        // è§£æ±ºæ–¹æ¡ˆï¼šè«‹çœ‹ä¸‹é¢å¾Œç«¯è£œå……
                        localStorage.setItem('storeUser', JSON.stringify(this.currentUser));
                        // é€™è£¡å‡è¨­å¾Œç«¯ login æœ‰å›å‚³ token (å¦‚æœæ²’æœ‰ï¼ŒfetchHistory æœƒå¤±æ•—)
                        // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘å‡è¨­ä½ å¾Œç«¯ login å·²ç¶“å›å‚³äº† token (æˆ‘å€‘å»æ”¹æ”¹å¾Œç«¯)
                        if(data.access_token) localStorage.setItem('storeToken', JSON.stringify(data.access_token));

                        if (!this.currentUser.is_reset_needed) this.fetchProducts();
                    } else { this.showToast('ç™»å…¥å¤±æ•—', 'bg-danger'); }
                } catch(e) { this.showToast('é€£ç·šéŒ¯èª¤', 'bg-danger'); } 
                finally { this.loading = false; }
            },
            logout() { this.currentUser = null; localStorage.removeItem('storeUser'); this.currentTab='order'; },
            async handleChangePassword() { /* ... åŒä¹‹å‰ ... */ },
            guessProductId(name) { if(name.includes("é›èƒ¸")) return 1; if(name.includes("ç‚¸ç²‰")) return 2; if(name.includes("è¾£ç²‰")) return 3; return 1; },
            showToast(msg, cls) { this.toastMessage=msg; this.toastClass=cls; this.toastInstance.show(); }
        }
    }).mount('#app')
</script>
</body>
</html>