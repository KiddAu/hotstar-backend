<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±ªå¤§å¤§ - åˆ†åº—è¨‚è²¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* ç™»å…¥å¡ç‰‡æ¨£å¼ */
        .login-card {
            max-width: 400px;
            margin: 60px auto;
            border-radius: 20px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            background: white;
            padding: 2rem;
        }

        /* å•†å“å¡ç‰‡æ¨£å¼ */
        .product-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            overflow: hidden;
        }
        .product-card:active { transform: scale(0.98); }
        .stock-tag { font-weight: bold; font-size: 0.85rem; }
        
        /* åº•éƒ¨å°èˆª/ç‹€æ…‹æ¬„ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #dee2e6;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>

    <div v-if="!currentUser" class="container px-3">
        <div class="login-card text-center">
            <h1 style="font-size: 3rem;">ğŸ—</h1>
            <h3 class="fw-bold text-dark mb-1">è±ªå¤§å¤§ç‚¸é›</h3>
            <p class="text-muted mb-4">åˆ†åº—è¨‚è²¨ç³»çµ± v2.0</p>
            
            <form @submit.prevent="handleLogin">
                <div class="form-floating mb-3 text-start">
                    <input type="text" class="form-control" id="uid" v-model="loginForm.username" placeholder="å¸³è™Ÿ" required>
                    <label for="uid">åˆ†åº—å¸³è™Ÿ (ID)</label>
                </div>
                <div class="form-floating mb-4 text-start">
                    <input type="password" class="form-control" id="pwd" v-model="loginForm.password" placeholder="å¯†ç¢¼" required>
                    <label for="pwd">å¯†ç¢¼</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5" :disabled="loading">
                    {{ loading ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥ç³»çµ±' }}
                </button>
            </form>
        </div>
    </div>

    <div v-else-if="currentUser.is_reset_needed" class="container px-3">
        <div class="login-card border-warning border-top border-5">
            <div class="text-center mb-4">
                <h1 style="font-size: 3rem;">âš ï¸</h1>
                <h4 class="fw-bold">å®‰å…¨æç¤º</h4>
                <p class="text-muted small">æ‚¨çš„å¯†ç¢¼å·²è¢«é‡ç½®ï¼Œç‚ºä¿éšœå¸³è™Ÿå®‰å…¨ï¼Œ<br>è«‹è¨­å®šä¸€å€‹æ–°çš„å¯†ç¢¼ã€‚</p>
            </div>
            
            <form @submit.prevent="handleChangePassword">
                <div class="mb-3">
                    <label class="form-label fw-bold">æ–°å¯†ç¢¼</label>
                    <input type="password" class="form-control form-control-lg" v-model="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" required>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-warning text-dark fw-bold py-3 rounded-pill">ç¢ºèªä¿®æ”¹</button>
                    <button type="button" class="btn btn-link text-muted" @click="logout">å–æ¶ˆä¸¦ç™»å‡º</button>
                </div>
            </form>
        </div>
    </div>

    <div v-else class="container pb-5" style="padding-top: 20px;">
        
        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
            <div>
                <h5 class="fw-bold mb-0 text-dark">{{ currentUser.display_name }}</h5>
                <small class="text-muted">ä»Šå¤©æƒ³è¨‚é»ä»€éº¼ï¼Ÿ</small>
            </div>
            <button class="btn btn-sm btn-outline-danger rounded-pill px-3" @click="logout">ç™»å‡º</button>
        </div>

        <div v-if="loadingProducts" class="text-center my-5 py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">æ­£åœ¨è¼‰å…¥åº«å­˜...</p>
        </div>

        <div class="row g-3" v-else>
            <div class="col-12 col-md-6 col-lg-4" v-for="item in products" :key="item.unit_id">
                <div class="card product-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title fw-bold mb-0 text-dark">{{ item.product_name }}</h5>
                            <span class="badge bg-light text-dark border">{{ item.selling_unit }}è£</span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-end">
                            <div>
                                <p class="mb-1 small text-muted">è¦æ ¼: {{ item.rate }} {{ item.base_unit }}/{{ item.selling_unit }}</p>
                                <p class="mb-0 stock-tag text-success">
                                    <span class="badge bg-success bg-opacity-10 text-success">ä¾›æ‡‰ä¸­</span>
                                </p>
                            </div>
                            
                            <div class="d-flex align-items-center bg-light rounded-pill p-1 border">
                                <input type="number" class="form-control form-control-sm border-0 bg-transparent text-center fw-bold" 
                                       style="width: 60px;" v-model.number="item.orderQty" placeholder="0" min="1">
                                <button class="btn btn-primary btn-sm rounded-circle shadow-sm" 
                                        style="width: 32px; height: 32px; padding: 0;"
                                        @click="placeOrder(item)" :disabled="!item.orderQty">
                                    +
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="height: 50px;"></div>
    </div>

    <div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 9999; width: 90%; max-width: 400px;">
        <div id="liveToast" class="toast align-items-center text-white border-0 shadow w-100" :class="toastClass" role="alert">
            <div class="d-flex">
                <div class="toast-body fs-6 fw-bold text-center w-100">
                    {{ toastMessage }}
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                apiUrl: 'https://hotstar-api.onrender.com/', // ğŸ”´ è«‹è¨˜å¾—æ”¹æˆä½ çš„ Render ç¶²å€ï¼
                
                // ç”¨æˆ¶ç‹€æ…‹
                currentUser: null,
                loginForm: { username: '', password: '' },
                newPassword: '',
                
                // ç”¢å“åˆ—è¡¨
                products: [],
                loading: false,
                loadingProducts: false,
                
                // UI
                toastMessage: '',
                toastClass: 'bg-success',
                toastInstance: null
            }
        },
        mounted() {
            this.toastInstance = new bootstrap.Toast(document.getElementById('liveToast'), { delay: 2000 });
            
            // è‡ªå‹•ç™»å…¥æª¢æŸ¥ (LocalStorage)
            const savedUser = localStorage.getItem('storeUser');
            if (savedUser) {
                this.currentUser = JSON.parse(savedUser);
                if (!this.currentUser.is_reset_needed) {
                    this.fetchProducts();
                }
            }
        },
        methods: {
            // 1. ç™»å…¥åŠŸèƒ½
            async handleLogin() {
                this.loading = true;
                try {
                    const res = await fetch(`${this.apiUrl}login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.loginForm)
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        this.currentUser = data.user;
                        this.loginForm = { username: '', password: '' };
                        
                        // å­˜å…¥ LocalStorage æ–¹ä¾¿ä¸‹æ¬¡ä¸ç”¨ç™»å…¥
                        localStorage.setItem('storeUser', JSON.stringify(this.currentUser));
                        
                        if (!this.currentUser.is_reset_needed) {
                            this.fetchProducts();
                        }
                    } else {
                        this.showToast(data.detail || "ç™»å…¥å¤±æ•—", 'bg-danger');
                    }
                } catch (e) {
                    this.showToast("ç¶²çµ¡é€£ç·šéŒ¯èª¤", 'bg-danger');
                } finally {
                    this.loading = false;
                }
            },

            // 2. ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½
            async handleChangePassword() {
                if (!this.newPassword) return;
                try {
                    const res = await fetch(`${this.apiUrl}change_password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.currentUser.id,
                            new_password: this.newPassword
                        })
                    });
                    
                    if (res.ok) {
                        alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹é‡æ–°ç™»å…¥");
                        this.logout();
                    } else {
                        alert("ä¿®æ”¹å¤±æ•—");
                    }
                } catch (e) {
                    alert("é€£ç·šéŒ¯èª¤");
                }
            },

            // 3. ç²å–ç”¢å“åˆ—è¡¨ (åªé¡¯ç¤ºä¸Šæ¶ä¸­)
            async fetchProducts() {
                this.loadingProducts = true;
                try {
                    const response = await fetch(`${this.apiUrl}products`);
                    const data = await response.json();
                    // åŠ å…¥ orderQty æ¬„ä½
                    this.products = data.map(item => ({ ...item, orderQty: null }));
                } catch (error) {
                    this.showToast('ç„¡æ³•è¼‰å…¥ç”¢å“åˆ—è¡¨', 'bg-danger');
                } finally {
                    this.loadingProducts = false;
                }
            },

            // 4. ä¸‹å–® (è‡ªå‹•å¸¶å…¥åˆ†åº—å)
            async placeOrder(item) {
                if (item.orderQty <= 0) return;

                const orderData = {
                    // ğŸ‘‡ é—œéµï¼šå¾ç™»å…¥è³‡è¨Šä¸­ç²å–åˆ†åº—åç¨±ï¼Œä¸å†éœ€è¦æ‰‹å‹•è¼¸å…¥
                    store_name: this.currentUser.display_name, 
                    product_id: item.product_name.includes('é›èƒ¸') ? 1 : 999, // âš ï¸æ³¨æ„ï¼šé€™è£¡çš„IDé‚è¼¯æœ€å¥½åœ¨å¾Œç«¯å®Œå–„ï¼Œæˆ–ä¾è³´ unit_id
                    // ç‚ºäº†æ›´æº–ç¢ºï¼Œæˆ‘å€‘ç›´æ¥ç”¨ API å›å‚³çš„ unit_id
                    unit_id: item.unit_id,
                    // Product ID å…¶å¯¦åœ¨ API å›å‚³åˆ—è¡¨æ™‚æ‡‰è©²è¦åŒ…åŸ‹ (æˆ‘å€‘ä¹‹å‰çš„ get_products API æ²’å›å‚³ product_idï¼Œåªå›å‚³äº† name)
                    // æš«æ™‚ hack: 
                    product_id: this.guessProductId(item.product_name), 
                    quantity: item.orderQty
                };
                
                try {
                    const response = await fetch(`${this.apiUrl}order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                    
                    if (response.ok) {
                        this.showToast('âœ… ä¸‹å–®æˆåŠŸï¼', 'bg-success');
                        item.orderQty = null;
                        // ä¸ä¸€å®šè¦åˆ·æ–°åˆ—è¡¨ï¼Œé™¤éä½ æƒ³é¡¯ç¤ºå³æ™‚åº«å­˜æ‰£æ¸›
                    } else {
                        const result = await response.json();
                        this.showToast(`âŒ å¤±æ•—: ${result.detail}`, 'bg-danger');
                    }
                } catch (error) {
                    this.showToast(`âŒ éŒ¯èª¤: ${error.message}`, 'bg-danger');
                }
            },

            // è¼”åŠ©ï¼šç°¡å–®åˆ¤æ–· Product ID (æ­£å¼ç‰ˆæ‡‰ç”±å¾Œç«¯ç›´æ¥æä¾› product_id)
            guessProductId(name) {
                if(name.includes("é›èƒ¸")) return 1;
                if(name.includes("ç‚¸ç²‰")) return 2;
                if(name.includes("è¾£ç²‰")) return 3;
                return 1; // Default
            },

            // 5. ç™»å‡º
            logout() {
                this.currentUser = null;
                this.newPassword = '';
                this.products = [];
                localStorage.removeItem('storeUser');
            },

            showToast(message, bgClass) {
                this.toastMessage = message;
                this.toastClass = bgClass;
                this.toastInstance.show();
            }
        }
    }).mount('#app')
</script>
</body>
</html>