<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±ªå¤§å¤§ - åˆ†åº—è¨‚è²¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è±ªå¤§å¤§">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1046/1046751.png">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom: 80px; }
        
        .login-card { max-width: 400px; margin: 60px auto; border-radius: 20px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.08); background: white; padding: 2rem; }
        .product-card { border: none; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); background: white; margin-bottom: 10px; }
        .qty-btn { width: 30px; height: 30px; padding: 0; border-radius: 50%; font-weight: bold; }
        .history-card { border: none; border-radius: 12px; background: white; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid #0d6efd; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: #adb5bd; font-size: 0.8rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        .delivery-banner { background-color: #e7f1ff; color: #0c5460; padding: 10px 15px; font-size: 0.9rem; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b8daff; display: flex; align-items: center; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>

    <div v-if="!currentUser" class="container px-3">
        <div class="login-card text-center">
            <h1 style="font-size: 3rem;">ğŸ—</h1>
            <h3 class="fw-bold text-dark mb-1">è±ªå¤§å¤§ç‚¸é›</h3>
            <p class="text-muted mb-4">åˆ†åº—è¨‚è²¨ç³»çµ± v3.1</p>
            <form @submit.prevent="handleLogin">
                <div class="form-floating mb-3 text-start"><input type="text" class="form-control" id="uid" v-model="loginForm.username" placeholder="å¸³è™Ÿ" required><label for="uid">åˆ†åº—å¸³è™Ÿ (ID)</label></div>
                <div class="form-floating mb-4 text-start"><input type="password" class="form-control" id="pwd" v-model="loginForm.password" placeholder="å¯†ç¢¼" required><label for="pwd">å¯†ç¢¼</label></div>
                <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5" :disabled="loading">{{ loading ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥ç³»çµ±' }}</button>
            </form>
        </div>
    </div>

    <div v-else-if="currentUser.is_reset_needed" class="container px-3 pt-5">
        <div class="login-card border-warning border-top border-5">
            <h4 class="fw-bold text-center">âš ï¸ å®‰å…¨æç¤º</h4>
            <p class="text-muted small text-center mb-4">è«‹è¨­å®šæ–°å¯†ç¢¼ä»¥ç¹¼çºŒä½¿ç”¨ã€‚</p>
            <form @submit.prevent="handleChangePassword">
                <input type="password" class="form-control form-control-lg mb-3" v-model="newPassword" placeholder="æ–°å¯†ç¢¼" required>
                <button type="submit" class="btn btn-warning w-100 py-2 fw-bold">ç¢ºèªä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <div v-else class="container pt-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0 text-dark">{{ currentUser.display_name }}</h5>
            <button class="btn btn-sm btn-light text-danger" @click="logout">ç™»å‡º</button>
        </div>

        <div v-if="currentTab === 'order'" class="delivery-banner shadow-sm">
            <span style="font-size: 1.2rem; margin-right: 10px;">ğŸš›</span>
            <div><strong>é è¨ˆé€è²¨ï¼š</strong> {{ estimatedDelivery }}<div style="font-size: 0.75rem; opacity: 0.8;">(æˆªå–®æ™‚é–“ 14:00)</div></div>
        </div>

        <div v-if="currentTab === 'order'">
            <div v-if="loadingProducts" class="text-center my-5"><div class="spinner-border text-primary" role="status"></div></div>
            <div v-else>
                <div class="row g-2">
                    <div class="col-12" v-for="item in products" :key="item.unit_id">
                        <div class="card product-card p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><h6 class="fw-bold mb-1">{{ item.product_name }}</h6><span class="badge bg-light text-dark border">{{ item.selling_unit }} ({{ item.rate }}{{ item.base_unit }})</span></div>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary qty-btn d-flex align-items-center justify-content-center" @click="item.orderQty = (item.orderQty > 0 ? item.orderQty - 1 : 0)" :disabled="!item.orderQty || item.orderQty <= 0">-</button>
                                    <input type="number" class="form-control form-control-sm border-0 text-center fw-bold mx-1" style="width: 50px; font-size: 1.1rem;" v-model.number="item.orderQty" placeholder="0" min="0">
                                    <button class="btn btn-primary qty-btn d-flex align-items-center justify-content-center" @click="item.orderQty = (item.orderQty || 0) + 1">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fixed-bottom p-3" style="bottom: 60px; z-index: 990;" v-if="cartTotalQty > 0">
                    <button class="btn btn-primary w-100 py-3 rounded-pill shadow fw-bold fs-5" @click="openConfirmModal">
                        ä¸‹å–® ({{ cartTotalQty }} ä»¶)
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'history'">
            <h5 class="fw-bold mb-3">ğŸ“¦ æœ€è¿‘ 20 ç­†è¨‚å–®</h5>
            <div v-if="loadingHistory" class="text-center my-5"><div class="spinner-border text-secondary" role="status"></div></div>
            <div v-else>
                <div v-for="order in orderHistory" :key="order.order_no" class="card history-card p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2"><div><div class="fw-bold text-dark">{{ order.date }}</div><div class="text-muted small">{{ order.order_no }}</div></div><span class="badge bg-success">å·²ç¢ºèª</span></div>
                    <div class="bg-light p-2 rounded mb-3 small"><div v-for="item in order.items" class="d-flex justify-content-between"><span>{{ item.product_name }}</span><span class="fw-bold">x {{ item.qty }} {{ item.unit_name }}</span></div></div>
                    <button class="btn btn-outline-primary w-100 btn-sm fw-bold" @click="quickReorder(order)">ğŸ”„ ç…§å–®å†è²· (Quick Reorder)</button>
                </div>
                <div v-if="orderHistory.length === 0" class="text-center text-muted py-5">æš«ç„¡æ­·å²è¨‚å–®</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmOrderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">ğŸ“ ç¢ºèªè¨‚å–®è©³æƒ…</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center py-3" v-for="item in cartItems" :key="item.unit_id">
                            <div>
                                <h6 class="mb-0 fw-bold">{{ item.product_name }}</h6>
                                <small class="text-muted">{{ item.selling_unit }}è£</small>
                            </div>
                            <span class="badge bg-primary rounded-pill fs-6">x {{ item.orderQty }}</span>
                        </div>
                    </div>
                    <div class="p-3 bg-light text-end border-top">
                        <span class="text-muted">ç¸½æ•¸é‡:</span> <span class="fw-bold fs-5 text-dark">{{ cartTotalQty }} ä»¶</span>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light text-muted flex-grow-1 py-2" data-bs-dismiss="modal">å†è«—è«— (No)</button>
                    <button type="button" class="btn btn-primary flex-grow-1 py-2 fw-bold" @click="submitOrder">ç¢ºèªæäº¤ (Yes)</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentUser && !currentUser.is_reset_needed" class="bottom-nav">
        <div class="nav-item" :class="{ active: currentTab === 'order' }" @click="currentTab = 'order'"><span class="nav-icon">ğŸ›’</span>ä¸‹å–®</div>
        <div class="nav-item" :class="{ active: currentTab === 'history' }" @click="switchTab('history')"><span class="nav-icon">ğŸ“œ</span>ç´€éŒ„</div>
    </div>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100;"><div id="liveToast" class="toast align-items-center text-white border-0 shadow" :class="toastClass" role="alert"><div class="d-flex"><div class="toast-body text-center w-100 fw-bold">{{ toastMessage }}</div></div></div></div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ğŸ‘‡ è¨»å†Š PWA Service Worker (æ–°å¢é€™æ®µ)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('PWA Service Worker è¨»å†ŠæˆåŠŸ: ', reg.scope))
                .catch(err => console.log('PWA Service Worker è¨»å†Šå¤±æ•—: ', err));
        });
    }
    
    const { createApp } = Vue

    createApp({
        data() {
            return {
                apiUrl: 'https://hotstar-api.onrender.com/', // ğŸ”´ è¨˜å¾—æ”¹æˆä½ çš„ç¶²å€ï¼
                
                currentUser: null, loginForm: { username: '', password: '' }, newPassword: '',
                currentTab: 'order', products: [], orderHistory: [],
                loading: false, loadingProducts: false, loadingHistory: false,
                toastMessage: '', toastClass: 'bg-success', 
                
                // Instances
                toastInstance: null, confirmModalInstance: null
            }
        },
        computed: {
            // ğŸ‘‡ æ–°å¢: è‡ªå‹•ç¯©é¸å‡ºæœ‰æ•¸é‡çš„å•†å“
            cartItems() {
                return this.products.filter(p => p.orderQty > 0);
            },
            cartTotalQty() {
                return this.products.reduce((sum, item) => sum + (item.orderQty || 0), 0);
            },
            estimatedDelivery() {
                const now = new Date();
                let d = new Date();
                d.setDate(now.getDate() + (now.getHours() < 14 ? 1 : 2));
                return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ä¸‹åˆ`;
            }
        },
        mounted() {
            this.toastInstance = new bootstrap.Toast(document.getElementById('liveToast'), { delay: 2000 });
            this.confirmModalInstance = new bootstrap.Modal(document.getElementById('confirmOrderModal')); // åˆå§‹åŒ– Modal
            
            const savedUser = localStorage.getItem('storeUser');
            if (savedUser) {
                this.currentUser = JSON.parse(savedUser);
                if (!this.currentUser.is_reset_needed) this.fetchProducts();
            }
        },
        methods: {
            switchTab(tab) {
                this.currentTab = tab;
                if (tab === 'history') this.fetchHistory();
            },
            async fetchProducts() {
                this.loadingProducts = true;
                try {
                    const r = await fetch(`${this.apiUrl}products`);
                    const data = await r.json();
                    this.products = data.map(newItem => {
                        const existing = this.products.find(p => p.unit_id === newItem.unit_id);
                        return { ...newItem, orderQty: existing ? existing.orderQty : null };
                    });
                } catch(e) { this.showToast('ç„¡æ³•é€£ç·š', 'bg-danger'); } finally { this.loadingProducts = false; }
            },
            async fetchHistory() {
                this.loadingHistory = true;
                try {
                    const r = await fetch(`${this.apiUrl}store/my_orders`, { headers: { 'Authorization': `Bearer ${JSON.parse(localStorage.getItem('storeToken'))}` } });
                    if(r.ok) this.orderHistory = await r.json();
                } catch(e) {} finally { this.loadingHistory = false; }
            },
            quickReorder(pastOrder) {
                this.products.forEach(p => p.orderQty = null);
                let matchCount = 0;
                pastOrder.items.forEach(oldItem => {
                    const target = this.products.find(p => p.unit_id === oldItem.unit_id);
                    if (target) { target.orderQty = oldItem.qty; matchCount++; }
                });
                if (matchCount > 0) { this.currentTab = 'order'; this.showToast(`å·²è¼‰å…¥ ${matchCount} é …å•†å“`, 'bg-success'); } 
                else { this.showToast('ç„¡æ³•åŒ¹é…å•†å“', 'bg-warning'); }
            },

            // ğŸ‘‡ æ–°å¢: æ‰“é–‹ç¢ºèªè¦–çª—
            openConfirmModal() {
                if (this.cartItems.length === 0) return;
                this.confirmModalInstance.show();
            },

            // ğŸ‘‡ ä¿®æ”¹: çœŸæ­£çš„ä¸‹å–®å‹•ä½œ (ç”± Modal çš„ç¢ºèªæŒ‰éˆ•è§¸ç™¼)
            async submitOrder() {
                this.confirmModalInstance.hide(); // é—œé–‰è¦–çª—
                
                this.showToast('æ­£åœ¨æäº¤è¨‚å–®...', 'bg-info');

                const payload = {
                    store_name: this.currentUser.display_name,
                    items: this.cartItems.map(item => ({ unit_id: item.unit_id, quantity: item.orderQty }))
                };
                
                try {
                    const response = await fetch(`${this.apiUrl}order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (response.ok) {
                        this.showToast(`âœ… ä¸‹å–®æˆåŠŸï¼`, 'bg-success');
                        this.products.forEach(p => p.orderQty = null);
                        setTimeout(() => { this.switchTab('history'); }, 1000);
                    } else {
                        this.showToast(`âŒ å¤±æ•—: ${result.detail}`, 'bg-danger');
                    }
                } catch (error) { this.showToast(`âŒ é€£ç·šéŒ¯èª¤`, 'bg-danger'); }
            },

            // Auth
            async handleLogin() {
                this.loading = true;
                try {
                    const r = await fetch(`${this.apiUrl}login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(this.loginForm) });
                    const data = await r.json();
                    if (r.ok) {
                        this.currentUser = data.user;
                        this.loginForm = { username: '', password: '' };
                        localStorage.setItem('storeUser', JSON.stringify(this.currentUser));
                        if(data.access_token) localStorage.setItem('storeToken', JSON.stringify(data.access_token));
                        if (!this.currentUser.is_reset_needed) this.fetchProducts();
                    } else { this.showToast(data.detail || "ç™»å…¥å¤±æ•—", 'bg-danger'); }
                } catch(e) { this.showToast('é€£ç·šéŒ¯èª¤', 'bg-danger'); } finally { this.loading = false; }
            },
            logout() { this.currentUser = null; localStorage.removeItem('storeUser'); localStorage.removeItem('storeToken'); this.currentTab='order'; },
            async handleChangePassword() {
                if (!this.newPassword) return;
                try {
                    const res = await fetch(`${this.apiUrl}change_password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: this.currentUser.id, new_password: this.newPassword }) });
                    if (res.ok) { alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹é‡æ–°ç™»å…¥"); this.logout(); } else { alert("ä¿®æ”¹å¤±æ•—"); }
                } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
            },
            showToast(msg, cls) { this.toastMessage=msg; this.toastClass=cls; this.toastInstance.show(); }
        }
    }).mount('#app')
</script>
</body>
</html>