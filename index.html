<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±ªå¤§å¤§ - åˆ†åº—è¨‚è²¨ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .login-card { max-width: 400px; margin: 50px auto; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="container py-4" v-cloak>

    <div v-if="!currentUser" class="login-card bg-white p-4">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">ğŸ” è±ªå¤§å¤§è¨‚è²¨</h2>
            <p class="text-muted">åˆ†åº—å°ˆç”¨ç³»çµ±</p>
        </div>
        <form @submit.prevent="handleLogin">
            <div class="mb-3">
                <label class="form-label">å¸³è™Ÿ ID</label>
                <input type="text" class="form-control" v-model="loginForm.username" placeholder="è¼¸å…¥åˆ†åº—å¸³è™Ÿ" required>
            </div>
            <div class="mb-4">
                <label class="form-label">å¯†ç¢¼</label>
                <input type="password" class="form-control" v-model="loginForm.password" placeholder="è¼¸å…¥å¯†ç¢¼" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg" :disabled="loading">
                    {{ loading ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥' }}
                </button>
            </div>
        </form>
    </div>

    <div v-else-if="currentUser.is_reset_needed" class="login-card bg-white p-4 border-warning border-top border-5">
        <h4 class="fw-bold text-center mb-3">âš ï¸ å®‰å…¨æç¤º</h4>
        <p class="small text-muted text-center mb-4">æ‚¨çš„å¯†ç¢¼å·²è¢«é‡ç½®ï¼Œç‚ºç¢ºä¿å¸³è™Ÿå®‰å…¨ï¼Œ<br>è«‹è¨­å®šä¸€å€‹æ–°çš„å¯†ç¢¼ã€‚</p>
        
        <form @submit.prevent="handleChangePassword">
            <div class="mb-3">
                <label class="form-label">æ–°å¯†ç¢¼</label>
                <input type="password" class="form-control" v-model="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-warning text-dark fw-bold">ç¢ºèªä¿®æ”¹</button>
            </div>
        </form>
    </div>

    <div v-else>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-0">ğŸ‘‹ ä½ å¥½ï¼Œ{{ currentUser.display_name }}</h4>
                <small class="text-muted">ä»Šå¤©æƒ³è¨‚é»ä»€éº¼ï¼Ÿ</small>
            </div>
            <button class="btn btn-outline-danger btn-sm" @click="logout">ç™»å‡º</button>
        </div>

        <div v-if="loadingProducts" class="text-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>

        <div class="row g-3" v-else>
            <div class="col-12 col-md-6 col-lg-4" v-for="item in products" :key="item.product_name + item.selling_unit">
                <div class="card h-100 border-0 shadow-sm product-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title fw-bold mb-0">{{ item.product_name }}</h5>
                            <span class="badge bg-info text-dark">{{ item.selling_unit }}è£</span>
                        </div>
                        
                        <p class="card-text text-muted mb-1">
                            æ›ç®—ç‡: 1{{ item.selling_unit }} = {{ item.rate }}KG
                        </p>
                        <p class="card-text mb-3">
                            åº«å­˜ç‹€æ…‹: <span class="badge bg-success">ä¾›æ‡‰ä¸­</span>
                        </p>

                        <div class="d-flex gap-2">
                            <input type="number" class="form-control" v-model.number="item.orderQty" min="1" placeholder="æ•¸é‡">
                            <button class="btn btn-primary flex-shrink-0" @click="placeOrder(item)" :disabled="!item.orderQty">
                                ä¸‹å–®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast align-items-center text-white border-0" :class="toastClass" role="alert">
            <div class="d-flex">
                <div class="toast-body fs-6">{{ toastMessage }}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                apiUrl: 'https://hotstar-api.onrender.com/', // ğŸ”´ è¨˜å¾—æ”¹æˆä½ çš„ Render ç¶²å€
                
                // ç”¨æˆ¶ç‹€æ…‹
                currentUser: null, // ç™»å…¥å¾Œæœƒå­˜ user object
                loginForm: { username: '', password: '' },
                newPassword: '', // ç”¨æ–¼ä¿®æ”¹å¯†ç¢¼
                
                // ç”¢å“èˆ‡ UI ç‹€æ…‹
                products: [],
                loading: false,
                loadingProducts: false,
                toastMessage: '',
                toastClass: 'bg-success',
                toastInstance: null
            }
        },
        mounted() {
            // åˆå§‹åŒ– Toast
            this.toastInstance = new bootstrap.Toast(document.getElementById('liveToast'));
        },
        methods: {
            // 1. ç™»å…¥åŠŸèƒ½
            async handleLogin() {
                this.loading = true;
                try {
                    const res = await fetch(`${this.apiUrl}login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.loginForm)
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        this.currentUser = data.user; // ç™»å…¥æˆåŠŸï¼
                        this.loginForm = { username: '', password: '' }; // æ¸…ç©ºè¡¨å–®
                        
                        // å¦‚æœä¸éœ€è¦æ”¹å¯†ç¢¼ï¼Œå°±ç«‹åˆ»æ‹‰å–å•†å“åˆ—è¡¨
                        if (!this.currentUser.is_reset_needed) {
                            this.fetchProducts();
                        }
                    } else {
                        alert(data.detail || "ç™»å…¥å¤±æ•—");
                    }
                } catch (e) {
                    alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡");
                } finally {
                    this.loading = false;
                }
            },

            // 2. ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½
            async handleChangePassword() {
                if (!this.newPassword) return;
                try {
                    const res = await fetch(`${this.apiUrl}change_password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.currentUser.id,
                            new_password: this.newPassword
                        })
                    });
                    
                    if (res.ok) {
                        alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚");
                        this.logout(); // å¼·åˆ¶ç™»å‡ºï¼Œé‡æ–°ç™»å…¥
                    } else {
                        alert("ä¿®æ”¹å¤±æ•—");
                    }
                } catch (e) {
                    alert("é€£ç·šéŒ¯èª¤");
                }
            },

            // 3. ç²å–å•†å“åˆ—è¡¨
            async fetchProducts() {
                this.loadingProducts = true;
                try {
                    const response = await fetch(`${this.apiUrl}products`);
                    const data = await response.json();
                    this.products = data.map(item => ({ ...item, orderQty: null }));
                } catch (error) {
                    this.showToast('ç„¡æ³•è®€å–å•†å“åˆ—è¡¨', 'bg-danger');
                } finally {
                    this.loadingProducts = false;
                }
            },

            // 4. ä¸‹å–®åŠŸèƒ½ (å·²å‡ç´šï¼šè‡ªå‹•å¸¶å…¥åˆ†åº—åç¨±)
            async placeOrder(item) {
                if (item.orderQty <= 0) return;

                const orderData = {
                    // ğŸ”´ é€™è£¡æ”¹ç”¨äº† currentUser çš„è³‡æ–™ï¼Œä¸å†éœ€è¦æ‰‹å‹•è¼¸å…¥åˆ†åº—å
                    store_name: this.currentUser.display_name, 
                    product_id: item.product_name === 'è±ªå¤§å¤§å°ˆç”¨é›èƒ¸è‚‰' ? 1 : 999, 
                    unit_id: item.unit_id,
                    quantity: item.orderQty
                };
                
                try {
                    const response = await fetch(`${this.apiUrl}order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                    
                    if (response.ok) {
                        this.showToast('âœ… æˆåŠŸä¸‹å–®ï¼', 'bg-success');
                        item.orderQty = null;
                        this.fetchProducts();
                    } else {
                        const result = await response.json();
                        this.showToast(`âŒ ä¸‹å–®å¤±æ•—: ${result.detail}`, 'bg-danger');
                    }
                } catch (error) {
                    this.showToast(`âŒ éŒ¯èª¤: ${error.message}`, 'bg-danger');
                }
            },

            // 5. ç™»å‡º
            logout() {
                this.currentUser = null;
                this.newPassword = '';
            },

            showToast(message, bgClass) {
                this.toastMessage = message;
                this.toastClass = bgClass;
                this.toastInstance.show();
            }
        }
    }).mount('#app')
</script>
</body>
</html>